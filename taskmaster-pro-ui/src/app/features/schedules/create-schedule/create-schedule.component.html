<mat-card class="form-card">
  <mat-card-title>Create New Schedule</mat-card-title>
  <mat-card-content>
    <form [formGroup]="scheduleForm" (ngSubmit)="submit()">
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Order ID</mat-label>
        <input
          matInput
          formControlName="orderId"
          placeholder="Order UUID"
          [matAutocomplete]="orderAuto"
          (blur)="validateOrderId(orderId.value)" />

        <!-- paste helper -->
        <button
          type="button"
          mat-icon-button
          matSuffix
          *ngIf="clipboardSupported"
          aria-label="Paste order id"
          (click)="pasteFromClipboard()"
          title="Paste from clipboard"
        >
          <mat-icon>content_paste</mat-icon>
        </button>

        <mat-hint *ngIf="searchTooShortOrder">
          Please type at least {{ searchMinLength }} characters to search.
        </mat-hint>

        <mat-hint *ngIf="validatingOrder">
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          Checking order…
        </mat-hint>
        <mat-error *ngIf="scheduleForm.get('orderId')?.hasError('required')">
          Order ID is required
        </mat-error>
        <mat-error *ngIf="!validatingOrder && scheduleForm.get('orderId')?.hasError('notFound')">
          Order not found
        </mat-error>

        <mat-autocomplete #orderAuto="matAutocomplete" (optionSelected)="onOrderSelected($event.option.value)">
          <mat-option *ngFor="let o of orderSuggestions$ | async" [value]="o.id">
            {{ o.id }} — {{ o.customerName || o.title || o.userEmail }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Start</mat-label>
        <input
          matInput
          [matDatepicker]="startPicker"
          formControlName="scheduledStart"
          [min]="nextMidnight" />
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
        <mat-error *ngIf="scheduleForm.get('scheduledStart')?.hasError('required')">
          Start date/time is required
        </mat-error>
        <mat-error *ngIf="scheduleForm.get('scheduledStart')?.hasError('beforeMidnight')">
          Start cannot be before midnight of next day
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>End</mat-label>
        <input
          matInput
          [matDatepicker]="endPicker"
          formControlName="scheduledEnd"
          [min]="scheduledStart.value ? addOneDay(scheduledStart.value) : nextMidnight" />
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
        <mat-error *ngIf="scheduleForm.get('scheduledEnd')?.hasError('required')">
          End date/time is required
        </mat-error>
        <mat-error *ngIf="scheduleForm.get('scheduledEnd')?.hasError('endBeforeStart')">
          End date/time must be the same or after Start date/time
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Title</mat-label>
        <input
          matInput
          formControlName="title"
          maxlength="250" />
        <mat-error *ngIf="scheduleForm.get('title')?.hasError('required')">
          Title is required
        </mat-error>
        <mat-error *ngIf="scheduleForm.get('title')?.hasError('maxlength')">
          Max length is 250 characters ({{ scheduleForm.get('title')?.value?.length || 0 }}/250)
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Description</mat-label>
        <textarea
          matInput
          formControlName="description"
          maxlength="1000"
          rows="5">
        </textarea>
        <mat-error *ngIf="scheduleForm.get('description')?.hasError('required')">
          Description is required
        </mat-error>
        <mat-error *ngIf="scheduleForm.get('description')?.hasError('maxlength')">
          Max length is 1000 characters ({{ description.value?.length || 0 }}/1000).
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Assigned To</mat-label>
        <input
          matInput
          formControlName="assignedTo"
          placeholder="Start typing user name..."
          [matAutocomplete]="userAuto"
          (blur)="validateAssignedTo(assignedTo.value)"
          [readonly]="!isAdmin" />

        <mat-hint *ngIf="searchTooShortUser">
          Please type at least {{ searchMinLength }} characters to search.
        </mat-hint>

        <mat-hint *ngIf="validatingAssigned">
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          Checking user…
        </mat-hint>

        <mat-error *ngIf="scheduleForm.get('assignedTo')?.hasError('required')">
          User is required
        </mat-error>
        <mat-error *ngIf="!validatingAssigned && scheduleForm.get('assignedTo')?.hasError('notFound')">
          User not found
        </mat-error>

        <mat-autocomplete
          #userAuto="matAutocomplete"
          [displayWith]="displayUser"
          (optionSelected)="onUserSelected($event.option.value)">
          <mat-option *ngFor="let u of userSuggestions$ | async" [value]="u">
            {{ u.email }} — {{ u.displayName }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <div class="button-group">
        <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Saving…' : 'Save' }}
        </button>
        <button mat-button (click)="cancel()" type="button">Cancel</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>